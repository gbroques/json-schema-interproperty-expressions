<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Schema Interproperty Expressions</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <form>
        <div>
            <label>
                Hub Pitch Circle Diameter
                <input
                    type="number"
                    name="HubPitchCircleDiameter"
                    value="100"
                    step="1"
                />
            </label>
            <p class="validationMessage"></p>
        </div>
        <div>
            <label>
                Hub Holes Diameter
                <input
                    type="number"
                    name="HubHolesDiameter"
                    value="12"
                    step="1"
                />
            </label>
            <p class="validationMessage"></p>
        </div>
        <div>
            <label>
                Rotor Disk Central Hole Diameter
                <input
                    type="number"
                    name="RotorDiskCentralHoleDiameter"
                    value="65"
                    step="1"
                />
            </label>
            <p class="validationMessage"></p>
        </div>
        <div>
            <label>
                Yaw Pipe Diameter
                <input
                    type="number"
                    name="YawPipeDiameter"
                    value="60.3"
                    step="0.1"
                />
            </label>
            <p class="validationMessage"></p>
        </div>
    </form>
    <img src="diagram.svg" alt="Diagram">
    <script src="evaluatePostfixExpression.js"></script>
    <script>
        const schema = {
            "type": "object",
            "properties": {
                "HubPitchCircleDiameter": {
                    "type": "number",
                    "title": "Hub Pitch Circle Diameter"
                },
                "HubHolesDiameter": {
                    "type": "number",
                    "title": "Hub Holes Diameter"
                },
                "RotorDiskCentralHoleDiameter": {
                    "type": "number",
                    "title": "Rotor Disk Central Hole Diameter"
                },
                "YawPipeDiameter": {
                    "type": "number",
                    "title": "Yaw Pipe Diameter"
                }
            },
            "interpropertyExpressions": [
                {
                    // Equivalent expression in infix notation:
                    // {HubPitchCircleDiameter} - {HubHolesDiameter} - 10 ≥ {RotorDiskCentralHoleDiameter}
                    "expression": "{HubPitchCircleDiameter} {HubHolesDiameter} - 10 - {RotorDiskCentralHoleDiameter} ≥",
                    "type": "postfix",  // or potentially "prefix" / "infix"
                    "message": "Must have 5 mm between central hole of rotor disk and hub holes.",
                    "properties": [
                        "HubPitchCircleDiameter",
                        "HubHolesDiameter",
                        "RotorDiskCentralHoleDiameter"
                    ]
                }
            ]
        };
        const form = document.forms[0];
        const handleInput = () => {
            const variables = extractVariables(form);
            for (const interpropertyExpression of schema.interpropertyExpressions) {
                const {expression, type, message, properties} = interpropertyExpression;

                const isValid = evaluateExpression(type, expression, variables);
                properties.forEach(property => {
                    setCustomValidity(form[property], isValid, message);
                });
            }
        };
        function evaluateExpression(type, expression, variables) {
            switch(type) {
                case "postfix":
                    return evaluatePostfixExpression(expression, variables);
                default:
                    throw new TypeError(`"${type}" expressions are not supported.`);
            }
        }
        Object.keys(schema.properties).forEach(property => {
            const inputElement = form[property];
            inputElement.addEventListener('input', handleInput);
        });
        function extractVariables(form) {
            const variables = {};
            for (const element of form.elements) {
                const {name, value} = element;
                const {type} = schema.properties[name];
                variables[element.name] = cast(value, type);
            }
            return variables;
        }
        /**
         * Casts a string into the appropriate JavaScript type.
         * 
         * @param {string} value String value.
         * @param {string} type JSON Schema type.
         * @see https://json-schema.org/understanding-json-schema/reference/type.html
         */
        function cast(value, type) {
            switch(type) {
                case "number":
                case "integer":
                    return Number(value);
                case "boolean":
                    return Boolean(value);
                default:
                    return value;
            }
        }
        function setCustomValidity(inputElement, isValid, message) {
            const validationMessageElement = getValidationMessageElement(inputElement);
            if (!isValid) {
                inputElement.setCustomValidity(message);
                validationMessageElement.innerText = message;
            } else {
                inputElement.setCustomValidity("");
                validationMessageElement.innerText = "";
            }
        }
        function getValidationMessageElement(inputElement) {
            return inputElement.parentElement.parentElement.lastElementChild;
        }
    </script>
</body>
</html>